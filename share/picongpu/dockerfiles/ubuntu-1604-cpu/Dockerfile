FROM       ubuntu:16.04
MAINTAINER Axel Huebl <a.huebl@hzdr.de>

# docker and image environment
ENV        DEBIAN_FRONTEND=noninteractive \
           FORCE_UNSAFE_CONFIGURE=1 \
           SPACK_ROOT=/usr/local \
           SPACK_EXTRA_REPO=/usr/local/share/spack-repo \
           PIC_PACKAGE='picongpu@develop backend=omp2b'

# install minimal spack dependencies
#   - adds gfortran for spack's openmpi package
#   - adds the standard editors for users: vim, nano
#     (excluded: emacs-nox pulls up to 90MB in)
#   - adds build tools which are NOT linked in the final app
#   - selected cuda toolkit components
# note: do you need more cuda toolkit components?
# check:   apt-get update && apt-cache search cuda && apt-cache search nvcc
RUN        apt-get update && \
           apt-get install -y --no-install-recommends \
              autoconf \
              build-essential \
              ca-certificates \
              coreutils \
              curl \
              environment-modules \
              gfortran \
              git \
              liblzma-dev \
              libbz2-dev \
              libpng-dev \
              nano \
              openssh-server \
              pkg-config \
              python \
              rsync \
              unzip \
              vim && \
           rm -rf /var/lib/apt/lists/*

# spack settings
COPY       packages.yaml modules.yaml $SPACK_ROOT/etc/spack/

# install spack && PIConGPU dependencies
# TODO: fix to a specific spack SHA or tag
RUN        curl -s -L https://github.com/spack/spack/archive/develop.tar.gz \
                | tar xzC $SPACK_ROOT --strip 1 && \
           mkdir -p $SPACK_EXTRA_REPO && \
           curl -s -L https://api.github.com/repos/ComputationalRadiationPhysics/spack-repo/tarball \
                | tar xzC $SPACK_EXTRA_REPO --strip 1 && \
           spack repo add $SPACK_EXTRA_REPO
RUN        spack install $PIC_PACKAGE && \
           spack clean -a

# load spack & picongpu environment on login
RUN        /bin/echo -e "source $SPACK_ROOT/share/spack/setup-env.sh\n" \
                        "spack load $PIC_PACKAGE\n" \
                        'if [ $(id -u) -eq 0 ]; then\n' \
                        '   function mpirun { $(which mpirun) --allow-run-as-root $@; }\n' \
                        '   function mpiexec { $(which mpiexec) --allow-run-as-root $@; }\n' \
                        '   export -f mpirun;\n' \
                        '   export -f mpiexec;\n' \
                        'fi' \
               > /etc/profile.d/picongpu.sh

# build example for out-of-the-box usage: LWFA
RUN        /bin/bash -l -c ' \
               pic-create $PICSRC/share/picongpu/examples/LaserWakefield /opt/picInputs/lwfa && \
               cd /opt/picInputs/lwfa && \
               pic-build && \
               rm -rf .build'

COPY       start_lwfa.sh /usr/bin/lwfa
CMD        /bin/bash -l
